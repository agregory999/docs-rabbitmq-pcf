---
title: Upgrading RabbitMQ for PCF
owner: London Services
---

This product enables automated upgrades between versions of the product and is deployed through Ops Manager.
In some cases, you might be required to take the cluster offline. 
When this is necessary, it is clearly noted in the release notes for that version.

The upgrade paths for each version are detailed at [Pivotal Network - RabbitMQ for PCF page](https://network.pivotal.io/products/p-rabbitmq).

## <a id="downtime"></a> Downtime When Upgrading

A guide for downtime during upgrade deployments is shown in the table below.
In some cases, the cluster remains available during a tile upgrade, but individual queues on cluster nodes may be taken offline.

This is only a guide, so before upgrading, check the release notes for the version you are upgrading to.


<table border="1" class="nice">
<tr>
  <th>Upgrade Type</th>
  <th>Will Downtime Be Required For This Upgrade / Update </th>
</tr>
<tr>
  <th>Major Tile Version</th>
  <td>The RabbitMQ cluster is taken offline for the duration of the upgrade.
  </td>
</tr>
<tr>
  <th>Minor Tile Version</th>
  <td>The RabbitMQ cluster is taken offline for the duration of the upgrade.
  </td>
</tr>
<tr>
  <th>Patch Tile Version</th>
  <td>Normally these are rolling deployments with each node being updated in turn.
      In these cases the cluster remains available, but individual queues may be taken offline as each node is restarted.
      There are specific migration paths that require downtime, which are identified in the release notes for that version. 
  </td>
<tr>
  <th>Stemcell-Only Patch Tile Version</th>
  <td>Where the patch update is only a new stemcell version these are rolling deployments with each node being updated in turn.
      In these cases the cluster remains available, but individual queues may be taken offline as each node is restarted.
  </td>
</tr>
</table>

## <a id="notes"></a> Notes on the Upgrade Process

Review the following before starting an upgrade of RabbitMQ for PCF: 

* Upgrading to a newer version of the product does not cause any loss of data or
configuration.

* It may take busy RabbitMQ nodes a long time to shut down during
the upgrade and you must not interrupt this process.

* The benefit you get from stemcell rolling
  upgrades depends on how you have configured network partition handling and the
  **Resource Config** tab.
  An HAProxy instance count of 2 and a RabbitMQ node count of 3 are required for rolling stemcell upgrades.
  As of v1.7.7, these counts are the default. 
  For more information, see [Clustering and Network Partitions](./partitions.html).

* The length of the downtime depends on whether there is a stemcell update to
replace the operating system image or if the existing VM can just have
the RabbitMQ software updated. Stemcell updates incur additional downtime while
the IaaS creates the new VM.

* The cluster becomes unavailable only when upgrading between specific versions of Erlang or RabbitMQ.
  This is clearly stated in the release notes for those versions.

* Ops Manager ensures the instances are updated with the new packages and any
configuration changes are applied automatically.

* For issues with upgrading RabbitMQ for PCF,
  see [Troubleshooting On-Demand RabbitMQ for PCF](./troubleshoot.html).



## <a id="preupgrade"></a> Before Upgrading to a Newer Version of RabbitMQ or Erlang

Review the following before starting an upgrade that includes a new version of RabbitMQ or Erlang:

* Ensure the cluster is healthy via the RabbitMQ Management UI. You cannot rely
on the BOSH `instances` output, that reflects the state of Erlang VM, not
RabbitMQ.

* Stop RabbitMQ when upgrading the RabbitMQ or Erlang VM
version.


## <a id="upgrade"></a> Upgrade RabbitMQ for PCF

To upgrade the product, follow these steps:

1. Download the latest version of the product from [Pivotal Network](https://network.pivotal.io/products/pivotal-rabbitmq-service).
1. Upload the new .pivotal file to Ops Manager.
1. Upload the stemcell associated with the update (*if required*).
1. Update any new mandatory configuration parameters (*if required*).
1. Click **Apply changes** in the Ops Manager Installation Dashboard.
   The rest of the process is automated.


## <a id="upgrade-ondemand"></a> About Upgrade On-Demand Instances from <br>RabbitMQ v3.6 to v3.7

Before RabbitMQ for PCF v1.12, on-demand service instances were deployed using RabbitMQ v3.6.
RabbitMQ for PCF v1.12 provides service plans with RabbitMQ v3.6 and v3.7. 

Using blue-green deployment pattern, you can upgrade existing on-demand service instances 
from RabbitMQ v3.6 to v3.7 with no downtime. Assuming you have two applications `Producer` and `Consumer` connected to a single
RabbitMQ 3.6 instance `rmq36`, the main steps would be:
1. Provision a new service instance `rmq37` using one of the 3.7 service plans
1. Configure federation between `rmq37` and `rmq36`
  - In `rmq37` add federation upstream and provide `rmq36` URI (you can find it by looking at `cf env` for any of your applications and
  it'll look like `amqp://[username]:[password]@[hostname]/[vhost]`)
  - Add a policy to federate all or selected exchanges from `rmq36`
1. Unbind `rmq36` and bind `rmq37` to `Consumer` 
1. Restart `Consumer` (you can use [`autopilot` plugin](https://github.com/contraband/autopilot) for zero-downtime restart)
1. Make sure that `Consumer` continues receiving messages
1. Unbind `rmq36` and bind `rmq37` to `Producer`
1. Restart the `Producer`

For more information, see [Blue-Green Application Deployments with RabbitMQ](https://content.pivotal.io/blog/blue-green-application-deployments-with-rabbitmq).
For additional information on configuring RabbitMQ federation, see [rabbitmq.com/federation.html](rabbitmq.com/federation.html).

## <a id="policy"></a> Release Policy

When a new version of RabbitMQ is released, a new version of RabbitMQ for PCF is released soon after.

Where there is a new version of RabbitMQ or another dependent software
component, such as the stemcell released due to a critical CVE, Pivotal's goal
is to release a new version of the product within 48 hours.
